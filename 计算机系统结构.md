<h1 align="center"> 计算机系统结构</h1>

# 第一章基础知识

系统结构的相关概念

- 计算机系统层次结构
- 计算机系统结构基本概念（广义机器、透明性、编译）
- 计算机系统结构、组织、实现的定义
- 计算机系统分类方法/Flynn分类法

基本原理和性能公式

- 大概率事件优先
- Amdahl定律
- 程序的局部性原理
- CPU性能计算
- 加速比公式应用
- 

## 计算机发展简介

第一台通用电子计算机诞生于1946年。

发展：电子管——晶体管——集成电路——大规模集成电路——超大规模集成电路——高性能、高密度、高速处理器、存储器、大规模并行处理的第五代计算机。

* 换代的主要标志：元器件更新——计算机速度、功能、可靠性不断提高而成本不断降低。
* 计算机系统结构的创新或变革：1980后出现RISC精简指令系统。

## 计算机系统结构基本概念

计算机是由硬件、软件、固件（固化的微程序）组成的复杂系统，按机器语言功能划分为多级层次结构。

| 层数 | 语言             | 应用                                               |
| ---- | ---------------- | -------------------------------------------------- |
| 0    | 布尔语言（硬件） |                                                    |
| 1    | 微程序指令       | 用微指令集编写微程序，固件、硬件来解释             |
| 2    | 传统机器语言     | 传统机器语言程序有L1级微程序或L0级硬联逻辑进行解释 |
| 3    | 操作系统         | 包括传统机器及操作系统级指令，由微程序解释         |
| 4    | 汇编语言         | 翻译成L3和L2级语言执行                             |
| 5    | 高级语言         | 通过编译程序翻译到L4或L3级，或通过解释方法实现     |
| 6    | 应用语言         | 由应用程序包翻译到L5                               |

L1和L2级机器用硬件实现，称为物理机。L3及以上用软件方式实现，称为虚拟机。L2是软硬件界面。

* 翻译和解释：
	* 翻译转换整个程序到低级语言执行。速度快、占用空间大。
	* 解释把每一条语句解释为低级语言的等效语句执行，速度慢、占用空间小。
* 透明性：一种本来存在的事物或属性，从某种角度看好像不存在或看不到。低层机器的属性对高层机器程序员来说通常是透明的。

**计算机系统结构：概念性结构：**计算机系统中主要部件及其逻辑连接结构：中央处理系统、存储系统、I/O子系统、互连系统

**计算机系统结构的实质：**确定计算机系统中软硬件的界面，界面之上是软件实现的功能、界面之下是硬件和固件实现的功能。

系统结构的主要功能及属性：

* 数据表示
* 寻址规则
* 寄存器定义
* 指令集
* 终端系统
* 机器工作状态的定义和切换
* 存储体系
* 信息保护
* I/O结构

**计算机组成：**计算机系统结构的逻辑实现，包含物理机器级中的数据流和控制流的组成以及逻辑设计等。着眼于：物理机器级内各事件的排序方式与控制方式、各部件的功能以及各部件之间的联系。

* 具有相同系统结构的计算机可以采用不同的计算机组成。

**计算机实现：**计算机组成的物理实现。着眼于：器件技术、微组装技术。

* 同一种计算机组成又可以采用多种不同的计算机实现。

### 体系结构、组织、实现例题

* 机器指令集的确定、主存容量与编址方式等属于计算机体系结构。
* 指令实现方式（取指令、去操作数、运算、送结果等的具体操作及排序方式）、主存速度与逻辑结构（多体交叉存储）等属于计算机组织（计算机组成）。
* 实现指令集中所有指令功能的具体电路、器件的设计、装配技术，存储器器件和逻辑电路的设计等属于计算机实现。

----

### 计算机分类法

* Flynn分类法：按照指令流和数据流的多倍性分类。

	* 指令流：计算机执行的指令序列
	* 数据流：由指令流调用的数据序列
	* 多倍性：在系统**最受限**的部件上，同时处于统一执行阶段的指令或数据的最大数目

	分为SISD（传统顺序处理计算机）、SIMD（阵列处理机）、MISD（多处理机）、MIMD（奇葩，有的文献把流水线结构看做MIMD）系统。

![image-20210615211604807](计算机系统结构.assets/image-20210615211604807.png)

* Handler分类法：根据并行度和流水线分类。

	$T=<k\times k', d \times d', w \times w'>$

	k：控制器数目，k'：控制器流水线中控制部件的数目

	d：PCU控制的ALU或PE数目，d'：指令流水线中ALU部件的数目

	w：ALU或PE的字长，w'：操作流水线中基本逻辑线路数目

* 冯氏分类法：用最大并行度$P_m$（单位时间内能够处理的最大二进制位数）分类。

	* 字串位串WSBS：纯串行处理机
	* 字串位并WSBP：传统单处理机
	* 字并位串WPBS：同时处理多个字的同一位
	* 字并位并WPBP：同时处理多个字的多个位

	平均并行度：$P_a = \frac{\sum_{i=1}^T P_i}{T}$

	T个周期内的平均利用率：$\mu = \frac{P_a}{P_m}$

### 计算机分类法例题

* CRAY-1计算机有1个CPU，12个相当于ALU或PE的处理部件，最多可以实现8级流水线。字长为64位，可以实现1～14位流水线处理。所以CRAY-1的体系结构可表示为： T(CRAY-1)=〈1×1，12×8，64×(1～14)〉。

## 计算机系统设计

计算机系统设计的定量原理：

* 大概率事件优先原理： 优先加速使用频率高的部件。是**最重要和最广泛采用的计算机设计准则**。

* 程序的局部性原理：

	* 时间局部性：程序即将用到的信息很可能就是目前正在使用的信息。
	* 空间局部性：程序即将用到的信息很可能与正在使用的信息在空间上临近。

* Amdahl定律：系统性能加速比与该部件在系统中的总执行时间有关。

	$加速比S_n=\frac{改进后性能}{改进前性能}=\frac{改进前用时}{改进后用时}$
	
	$S_n = \frac{T_0}{T_n} = \frac{1}{(1-F_e)+\frac{F_e}{S_e}}$，$S_e$为部件加速比

### Amdahl例题	

某计算机系统采用浮点运算部件后，使浮点运算速度提高到原来的25倍，而系统运行某一程序的整体性能提高到原来的4倍，试计算该程序中浮点操作所占的比例。

由题可知：  Se = 25    Sn = 4。根据加速比可得：$4=\frac{1}{(1-F_e)+\frac{F_e}{25}}$，得Fe=78.1%

## CPU性能公式

CPU时间：执行一个程序所需CPU时间，$CPU_{时间}=执行程序所需的时钟周期数 \times 时钟周期时间$。

时钟周期时间$t = 1/f(系统时钟频率)$

CPI：一条指令的平均时钟周期数，$CPI=执行程序所需的时钟周期数 \div IC(执行程序的指令条数)$

* CPU性能取决于三个参数：
	* t：取决于硬件实现技术和计算机组成
	* CPI：取决于计算机组成和指令系统的结构
	* IC：取决于指令系统的结构和编译技术

### CPU性能例题

假设FP指令的比例为25%，其中，FPSQR占全部指令的比例为2%，FP操作的CPI为4，FPSQR操作的CPI为20 ，其他指令的平均CPI为1.33。现有两种改进方案，第一种是把FPSQR操作的CPI减至2，第二种是把所有的FP操作的CPI减至2，比较两种方案对系统性能的提高程度。

解：改进前，指令的平均时钟周期CPI为： $4 \times 0.25 + 1.33 \times 0.75 = 2$

第一种方案：CPI改进了$(20-2) \times 0.02 = 0.36$

第二种方案：CPI改进了$(4-2) \times 0.25 = 0.5$

第二种方案的改进较大。

# 第三章流水线

## 流水线基本概念

流水线技术主要思想是把一个复杂任务分解为若干个子任务。每个子任务由专门功能部件完成，并使多个子任务并行执行。

流水线技术的核心：部件功能专用化。（一件工作按功能分隔为若干相互联系的部分，每一部分指定给专门部件（段）完成，各部件（段）执行过程时间重叠，所有部件依次序分工完成工作。）

流水线的级：流水线中每个子过程及其功能部件，称为一个流水段。流水线的段数称为流水线深度（长度）

* 操作部件采用流水线，称为操作部件流水线
* 指令执行过程采用流水线，称为指令流水线
* 访问主存部件采用流水线，称为访存部件流水线
* 多计算机通过存储器连接构成流水线，称为宏流水线

流水线的分类1：

* 部件级流水线（运算操作流水线）：各类型的运算操作按流水方式进行。
* 处理级流水线（指令流水线）：把一条指令的执行过程分段，按流水方式执行。
* 系统级流水线（宏流水线）：把多台处理机串行连接起来，每个处理机完成整个任务中的一部分。

流水线的分类2：

* 单功能流水线：只能完成固定功能。
* 多功能流水线：流水线的各段可以进行不同连接，实现不同功能。

流水线的分类3：

* 静态流水线：同一时间内，多功能流水线中的各段只能按同一种功能的连接方式进行工作。
* 动态流水线：同一时间内，多功能流水线中的各段可以按照不同方式连接，同时执行多种功能。（而不需等到排空之后重新装入）

流水线的分类4：

* 线性流水线：流水线各段串行连接，每个段最多流过一次。
* 非线性流水线：流水线中有反馈回路，每个段可以流过多次。

流水线的分类5：

* 顺序流水线：流水线输出的任务顺序与输入的任务顺序相同。
* 乱序流水线：流水线输出的任务顺序与输入的顺序**可以不同**。（也称无序、错序、异步流水线）

典型的指令流水线：

* 三段：取指、分析、执行
* 四段：取指（访问主存取出指令并送到指令寄存器）、译码（形成操作数地址并读取操作数）、执行（完成指令的功能）、存结果（将运算结果写回寄存器或主存）

流水线通过时间和排空时间：

* 通过时间：第一个任务**从**进入流水线**到**流出结果所需的时间，又称装入时间

* 排空时间：最后一个任务从进入流水线到流出结果所需的时间

	在装入和排空的过程中，流水线不满载。

指令通过流水线时间最长的段称为**流水线瓶颈**。

每段流水线后面有一个**缓冲寄存器**，称为**流水寄存器**。有**缓冲、隔离、同步**作用。

## 流水线性能指标

吞吐率、加速比、效率、最佳段数。

### 吞吐率TP

单位时间内流水线完成的任务数量或输出结果的数量。$TP = \frac{n}{T}$

* 各段时间相等的流水线：理想的k段线性流水线完成n个连续任务的时间：$T_k = (k+n-1) \Delta t$

	实际吞吐率：$\frac{n}{(k+n-1) \Delta t}$

	最大吞吐率：$TP_{max}=\lim\limits_{n \to \infty} \frac{n}{(k+n-1) \Delta t} = \frac{1}{\Delta t}$

* 各段时间不等的流水线：时间最长段称为流水线的瓶颈$T_k = \sum\limits_{i=1}^k \Delta t_i + (n-1) \max (\Delta t_1,\Delta t_2,···,\Delta t_k)$

### 加速比S

完成同样任务，不使用流水线所用时间与使用流水线所用时间之比。$S=\frac{T_s}{T_k}$

* 各段时间相等的k段流水线：$S = \frac{n \times k \Delta t}{(k+n-1) \Delta t}$

	最大加速比：k

* 各段时间不等的流水线：$S = \frac{n \sum\limits_{i=1}^k \Delta t_i}{\sum\limits_{i=1}^k \Delta t_i + (n-1) \max (\Delta t_1,\Delta t_2,···,\Delta t_k)}$

### 效率E

流水线中的设备实际使用时间与整个运行时间的比值，又称流水线设备利用率

连续完成n个任务，每段的效率计算：每段都执行了n个任务，用时$n \Delta t$，效率$e = \frac{n \Delta t}{(k+n-1) \Delta t}$

整条流水线的效率$E = \frac{e_1+e_2+...+e_k}{k}= \frac{n}{k+n-1}$

### TP、S、E关系

$E=P \times \Delta t$、$E = \frac{S}{k}$

### 解决流水线瓶颈的方法

* 重复设置瓶颈段：让多个瓶颈流水段并行工作
* 瓶颈段再细分：细分为多个子流水段（每个子流水段用时和非瓶颈段相同），形成超流水线

### 流水线的最佳段数

流水线段数增加，吞吐率、加速比和价格均提高。

PCR定义为单位价格的最大吞吐率。

$PCR = \frac{P_{max}}{C}$，其中$P_{max} = \frac{1}{\frac{t}{k}+d}$，$C = \frac{1}{a+b \times k}$。t为非流水机器串行完成一个任务的时间，d为锁存器延迟，a为流水段本身价格，b为锁存器价格。

对k求导可得PCR极大值，以及对应的最佳段数$k_0$。$k_0 = \sqrt{\frac{t \times a}{d \times b}}$

大于等于8段的流水线称为超流水线。

## 流水线例题

<img src="计算机系统结构.assets/image-20210616154958511.png" alt="image-20210616154958511" style="zoom:50%;" />

解：是静态流水线，不能动态切换流水线功能。因此应算完全部加法再算乘法。

<img src="计算机系统结构.assets/image-20210616155129119.png" alt="image-20210616155129119" style="zoom:50%;" />



















